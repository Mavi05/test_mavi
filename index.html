<!DOCTYPE html>
<html>
<head>
    <title>Figma UX Evaluator Proxy</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: #f0f0f0;
        }
        .loader {
            text-align: center;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #18a0fb;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="loader">
        <div class="spinner"></div>
        <p>Analyzing design with AI...</p>
    </div>

    <script>
        // Listen for messages from the parent (Figma plugin)
        window.addEventListener('message', async (event) => {
            if (event.data.type === 'analyze-request') {
                const { ollamaUrl, modelName, prompt, imageData, requestId } = event.data;
                
                try {
                    // Make the API call to Ollama with longer timeout
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 1200000); // 20 minutes timeout
                    
                    const response = await fetch(`${ollamaUrl}/api/generate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model: modelName,
                            prompt: prompt,
                            images: [imageData],
                            stream: false,
                            options: {
                                temperature: 0.7,
                                top_p: 0.9,
                                num_ctx: 4096
                            }
                        }),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        throw new Error(`Ollama API error: ${response.status} ${response.statusText}`);
                    }

                    const data = await response.json();
                    
                    // Send success response back to plugin
                    parent.postMessage({
                        pluginMessage: {
                            type: 'analyze-response',
                            requestId: requestId,
                            success: true,
                            data: data.response
                        }
                    }, '*');

                } catch (error) {
                    let errorMessage = error.message;
                    
                    if (error.name === 'AbortError') {
                        errorMessage = 'Request timed out after 2 minutes. Try with a smaller image or check if Ollama is responding.';
                    } else if (error.message.includes('Failed to fetch')) {
                        errorMessage = 'Cannot connect to Ollama. Make sure it is running and CORS is enabled.';
                    }
                    
                    // Send error response back to plugin
                    parent.postMessage({
                        pluginMessage: {
                            type: 'analyze-response',
                            requestId: requestId,
                            success: false,
                            error: errorMessage
                        }
                    }, '*');
                }
            }
        });

        // Let the plugin know we're ready
        parent.postMessage({
            pluginMessage: {
                type: 'proxy-ready'
            }
        }, '*');
    </script>
</body>
</html>
