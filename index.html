<!DOCTYPE html>
<html>
<head>
    <title>Figma UX Evaluator Proxy</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: #f0f0f0;
        }
        .loader {
            text-align: center;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #18a0fb;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="loader">
        <div class="spinner"></div>
        <p>Analyzing design with OpenAI...</p>
    </div>

    <script>
        // Listen for messages from the parent (Figma plugin)
        window.addEventListener('message', async (event) => {
            if (event.data.type === 'openai-request') {
                const { apiKey, modelName, prompt, imageData, requestId } = event.data;
                
                try {
                    // Make the API call to OpenAI
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 seconds timeout
                    
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: modelName,
                            messages: [
                                {
                                    role: "user",
                                    content: [
                                        {
                                            type: "text",
                                            text: prompt
                                        },
                                        {
                                            type: "image_url",
                                            image_url: {
                                                url: `data:image/png;base64,${imageData}`,
                                                detail: "high"
                                            }
                                        }
                                    ]
                                }
                            ],
                            max_tokens: 1000,
                            temperature: 0.7
                        }),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`OpenAI API error: ${response.status} - ${errorData.error?.message || response.statusText}`);
                    }

                    const data = await response.json();
                    
                    // Send success response back to plugin
                    parent.postMessage({
                        pluginMessage: {
                            type: 'openai-response',
                            requestId: requestId,
                            success: true,
                            data: data.choices[0].message.content
                        }
                    }, '*');

                } catch (error) {
                    let errorMessage = error.message;
                    
                    if (error.name === 'AbortError') {
                        errorMessage = 'Request timed out. Please try again.';
                    } else if (error.message.includes('401')) {
                        errorMessage = 'Invalid API key. Please check your OpenAI API key.';
                    } else if (error.message.includes('429')) {
                        errorMessage = 'Rate limit exceeded. Please wait a moment and try again.';
                    } else if (error.message.includes('Failed to fetch')) {
                        errorMessage = 'Network error. Please check your internet connection.';
                    }
                    
                    // Send error response back to plugin
                    parent.postMessage({
                        pluginMessage: {
                            type: 'openai-response',
                            requestId: requestId,
                            success: false,
                            error: errorMessage
                        }
                    }, '*');
                }
            }
        });

        // Let the plugin know we're ready
        parent.postMessage({
            pluginMessage: {
                type: 'proxy-ready'
            }
        }, '*');
    </script>
</body>
</html>
